{% extends "layout.html" %}
{% block content %}
<article class="media content-section">
        <div class="media-body">
          <div class="article-metadata d-flex align-items-center">
            <div class="media-left mr-3">
                <img src="{{ url_for('static', filename=post.author.image_file) }}" alt="Profile Picture"
                     class="rounded-circle" style="width: 50px; height: 50px;">
            </div>
            <!-- Poster username and post date -->
            <div>
                <a class="mr-2" href="{{ url_for('users.user_posts', username=post.author.username) }}">{{ post.author.username }}</a>
                <small class="text-muted d-block">{{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>
          </div>
        </div>
        <h2 class="article-title">{{ post.title }}</h2>
        <p class="article-content">{{ post.content }}</p>

        {% if post.image_file %}
        <div class="post-image-content">
            {% if post.image_file.endswith('.gif') %}
                <img src="{{ url_for('static', filename=post.image_file) }}" alt="Post GIF" class="img-fluid mt-3" autoplay loop inline onclick="openImageModal(this)">
            {% else %}
                <img src="{{ url_for('static', filename=post.image_file) }}" alt="Post Image" class="img-fluid mt-3" onclick="openImageModal(this)">
            {% endif %}
        </div>
        {% endif %}

        
        <div class="article-footer">
            <!-- Like/Dislike Buttons -->
            <div class="like-dislike-container-post">
                <div class="post-likes-dislikes">
                    <button class="btn thumbs-up-btn {% if current_user in post.liked_by %}btn-success{% else %}btn-outline-success{% endif %}" 
                        id="like-btn-{{ post.id }}" onclick="likePost({{ post.id }})">
                    üëç <span id="like-count-{{ post.id }}">{{ post.like_count() }}</span>
                    </button>
                    <button class="btn thumbs-down-btn {% if current_user in post.disliked_by %}btn-danger{% else %}btn-outline-danger{% endif %}" 
                        id="dislike-btn-{{ post.id }}" onclick="dislikePost({{ post.id }})">
                    üëé <span id="dislike-count-{{ post.id }}">{{ post.dislike_count() }}</span>
                    </button>
                </div>
                {% if post.author == current_user %}
                <div class="dropdown">
                    <button class="btn btn-dark btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Actions
                    </button>
                    <div class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="{{ url_for('posts.update_post', post_id=post.id) }}">Edit</a>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#deleteModal-{{ post.id }}">Delete</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</article>

<!-- Divider between post and comments section -->
<hr class="section-divider">

<!-- Comments Section -->
<div class="comments-section mt-5">
    <h3>Comments</h3>
    {% for comment in comments %}
        <div class="media comment-item">
            <div class="media-body">
                <div class="comment-metadata">
                    <img class="rounded-circle comment-image-left" src="{{ url_for('static', filename=users[comment.user_id].image_file) }}" alt="Profile Image" />
                    <h5 class="mt-0">{{ users[comment.user_id].username }}</h5>
                    <small class="text-muted">{{ comment.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>

                <p class="comment-content">{{ comment.content }}</p>

                {% if comment.image_file %}
                    {% if post.image_file.endswith('.gif') %}
                        <img src="{{ url_for('static', filename=comment.image_file) }}" alt="Comment GIF" class="post-image-content" autoplay loop inline onclick="openImageModal(this)">
                    {% else %}
                        <img src="{{ url_for('static', filename=comment.image_file) }}" alt="Comment Image" class="post-image-content" onclick="openImageModal(this)">
                    {% endif %}
                {% endif %}

                <!-- Like/Dislike Buttons for Comments -->
                <div>
                    <button class="btn thumbs-up-btn {% if current_user in comment.liked_by %}btn-success{% else %}btn-outline-success{% endif %}" 
                        id="like-btn-comment-{{ comment.id }}" onclick="likeComment({{ comment.id }})">
                        üëç <span id="like-count-comment-{{ comment.id }}">{{ comment.like_count() }}</span>
                    </button>
                    <button class="btn thumbs-down-btn {% if current_user in comment.disliked_by %}btn-danger{% else %}btn-outline-danger{% endif %}" 
                        id="dislike-btn-comment-{{ comment.id }}" onclick="dislikeComment({{ comment.id }})">
                        üëé <span id="dislike-count-comment-{{ comment.id }}">{{ comment.dislike_count() }}</span>
                    </button>
                
                    {% if users[comment.user_id] == current_user or current_user.admin %}
                    <div class="dropdown">
                        <button class="btn btn-dark btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Actions
                        </button>
                        <div class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="{{ url_for('posts.edit_comment', comment_id=comment.id) }}">Edit</a>
                            <a class="dropdown-item" href="#" onclick="deleteComment({{ comment.id }})">Delete</a>
                        </div>
                    </div>
    
                    <form id="delete-comment-form-{{ comment.id }}" action="{{ url_for('posts.delete_comment', comment_id=comment.id) }}" method="POST" style="display:none;">
                        {{ form.hidden_tag() }}
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endfor %}
</div>

<!-- Image Modal for Full Screen View -->
<div id="imageModal" class="modal">
    <span class="close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="caption"></div>
</div>

<!-- Comment Form -->
{% if current_user.is_authenticated %}
<div class="comment-form mt-4">
    <form method="POST" action="" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.content.label(class="form-control-label") }}
            {{ form.content(class="form-control form-control-lg") }}
        </div>
        <!-- File input for image upload -->
        <div class="form-group">
            {{ form.image.label(class="form-control-label") }}
            {{ form.image(class="form-control-file") }}
        </div>
        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>
{% else %}
<p>You need to <a href="{{ url_for('users.login') }}">log in</a> to comment.</p>
  {% endif %}

  <script src="{{ url_for('static', filename='js/posts.js') }}" defer></script>

<!-- Custom JavaScript for Modal -->
<script>
function openImageModal(imageElement) {
    var modal = document.getElementById("imageModal");
    var modalImg = document.getElementById("modalImage");
    var captionText = document.getElementById("caption");

    modal.style.display = "block";
    modalImg.src = imageElement.src;
    captionText.innerHTML = imageElement.alt;

    // Close modal when clicking anywhere on it (including the image)
    modal.onclick = function() {
        modal.style.display = "none";
    }
}

function closeImageModal() {
    var modal = document.getElementById("imageModal");
    modal.style.display = "none";
}
</script>
    
<style>
/* Modal Style */
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    padding-top: 60px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.9);
}

.modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
}

#caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
}

.close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}
</style>

{% endblock content %}
