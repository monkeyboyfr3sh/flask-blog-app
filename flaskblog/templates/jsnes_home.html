{% extends "layout.html" %}

{% block content %}
    <script src="{{ url_for('static', filename='js/jsnes.min.js') }}"></script>    
    <h1>NES Emulator</h1>

    <!-- ROM loading progress -->
    <div id="loading-container" style="display:none;">
        <p>Loading ROM: <span id="progress-percent">0%</span></p>
        <progress id="progress-bar" max="100" value="0"></progress>
    </div>

    <canvas id="nes-canvas" width="256" height="240"></canvas>

    <!-- Emulator controls -->
    <div id="controls">
        <button id="start">Start</button>
        <button id="select">Select</button>
        <button id="a">A</button>
        <button id="b">B</button>
        <button id="up">Up</button>
        <button id="down">Down</button>
        <button id="left">Left</button>
        <button id="right">Right</button>
    </div>

    <!-- Full Screen button -->
    <button id="fullscreen">Full Screen</button>

    <!-- Key mapping guide -->
    <div id="key-guide">
        <p>Key Mappings:</p>
        <ul>
            <li>Start: Enter</li>
            <li>Select: C</li>
            <li>A: X</li>
            <li>B: Z</li>
            <li>Directional Pad: Arrow keys</li>
        </ul>
    </div>

    <!-- ROM loader -->
    <input type="file" id="rom-loader" accept=".nes" />

    <script>
        const nes = new jsnes.NES({
            onFrame: function(framebuffer_24) {
                const canvas = document.getElementById('nes-canvas');
                const context = canvas.getContext('2d');
                const imageData = context.createImageData(256, 240);

                for (let i = 0; i < framebuffer_24.length; i++) {
                    imageData.data[i * 4 + 2] = (framebuffer_24[i] >> 16) & 0xFF;  // Red
                    imageData.data[i * 4 + 1] = (framebuffer_24[i] >> 8) & 0xFF;   // Green
                    imageData.data[i * 4 + 0] = framebuffer_24[i] & 0xFF;          // Blue
                    imageData.data[i * 4 + 3] = 0xFF;                              // Alpha
                }
                context.putImageData(imageData, 0, 0);
            }
        });

        // Hardcoded key mapping
        const controlMapping = {
            'Enter': jsnes.Controller.BUTTON_START,          
            'c': jsnes.Controller.BUTTON_SELECT,  
            'x': jsnes.Controller.BUTTON_A,                  
            'z': jsnes.Controller.BUTTON_B,                  
            'ArrowUp': jsnes.Controller.BUTTON_UP,           
            'ArrowDown': jsnes.Controller.BUTTON_DOWN,       
            'ArrowLeft': jsnes.Controller.BUTTON_LEFT,       
            'ArrowRight': jsnes.Controller.BUTTON_RIGHT      
        };

        // Bind controls to keydown and keyup events
        document.addEventListener('keydown', (event) => {
            const button = controlMapping[event.key];
            if (button !== undefined) {
                nes.buttonDown(1, button);
            }
        });

        document.addEventListener('keyup', (event) => {
            const button = controlMapping[event.key];
            if (button !== undefined) {
                nes.buttonUp(1, button);
            }
        });

        // Load ROM file
        document.getElementById('rom-loader').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();

                // Progress tracking
                document.getElementById('loading-container').style.display = 'block';
                reader.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percentLoaded = Math.round((event.loaded / event.total) * 100);
                        document.getElementById('progress-bar').value = percentLoaded;
                        document.getElementById('progress-percent').textContent = percentLoaded + '%';
                    }
                };

                // Load the ROM as binary string
                reader.onload = function() {
                    try {
                        const binaryString = reader.result;
                        nes.loadROM(binaryString);
                        startEmulator();  // Start emulator once ROM is loaded
                        document.getElementById('loading-container').style.display = 'none';
                    } catch (error) {
                        console.error("Error loading ROM:", error);
                        alert("Failed to load ROM. Please try again with a valid ROM.");
                    }
                };

                reader.onerror = function() {
                    console.error("Failed to read the ROM file.");
                    alert("Error reading the file. Please try again.");
                };

                reader.readAsBinaryString(file);
            }
        });

        // Emulator loop
        function startEmulator() {
            function frame() {
                nes.frame();  // Render the next frame of the game
                requestAnimationFrame(frame);  // Continue rendering
            }
            frame();  // Start the rendering loop immediately after ROM is loaded
        }

        // Full screen mode
        document.getElementById('fullscreen').addEventListener('click', function() {
            const canvas = document.getElementById('nes-canvas');
            if (canvas.requestFullscreen) {
                canvas.requestFullscreen();
            } else if (canvas.mozRequestFullScreen) { 
                canvas.mozRequestFullScreen();
            } else if (canvas.webkitRequestFullscreen) { 
                canvas.webkitRequestFullscreen();
            } else if (canvas.msRequestFullscreen) { 
                canvas.msRequestFullscreen();
            }
        });

        // Resize canvas dynamically
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('nes-canvas');
            const container = canvas.parentNode;
            const scale = Math.min(container.clientWidth / 256, container.clientHeight / 240);
            canvas.width = Math.floor(256 * scale);
            canvas.height = Math.floor(240 * scale);
        });

        // Trigger initial resize
        window.dispatchEvent(new Event('resize'));
    </script>
{% endblock %}
